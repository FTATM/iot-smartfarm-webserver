<!-- JavaScript -->
<script>
    let sensors = {};
    let costs = {};
    let sensor_select = 0;
    document.addEventListener('DOMContentLoaded', async () => {
        await loadSensorData();
        await Card1(sensors);
        await Card2(sensors);
        await Card3(costs);
        await Card4(costs);

        await loadGraphsensorById();

        initMetricBars();
        setInterval(async () => {
            await loadSensorData();
        }, 30000);

    });

    async function loadSensorData() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: ["Voltage_S", "Current_S", "Power_S", "Voltage_L", "Current_L", "Power_L"]
                    })
                }
            );
            const data = await res.json();
            sensors = data['sensors'];
            console.log('âœ… raw sensor data:', sensors);

            Create_sensorCard(sensors);
            const firstKey = Object.keys(sensors)[0];
            sensor_select = sensors[firstKey].monitor_id ?? 0;

        } catch (err) {
            console.error('âŒ loadSensorData error:', err);
        }
    }

    function Create_sensorCard(sensors) {
        let metricsCards = document.getElementById('metrics-cards');
        metricsCards.innerHTML = "";
        Object.entries(sensors).forEach(([key, row]) => {
            const min = row['min'] ?? 0;
            const max = row['max'] ?? 1;
            let value = row.logs.length > 0 ? row.logs[0].data_value : 0;
            let div = document.createElement('div');
            div.id = `card-${key}`;
            div.className = "bg-white rounded-2xl p-4 border border-stone-200 shadow-sm flex flex-col h-32 hover:ring-2 hover:ring-orange-400 transition-all duration-20 shrink-0";
            div.innerHTML = `
                <div class="w-full flex justify-between items-center">
                    <span class="text-[9px] font-bold text-stone-500 uppercase tracking-widest">
                        ${key}
                    </span>
                    <span class="px-2 py-0.5 rounded-full bg-stone-100 text-stone-500 text-[9px] font-bold uppercase status">
                        --
                    </span>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    <div class="flex items-baseline gap-1">
                        <span class="text-lg font-black text-black value">
                            ${value}
                        </span>
                        <span class="text-sm font-bold text-stone-400">
                            ${row.unit}
                        </span>
                    </div>
                </div>

                <!-- Range Bar with Fixed Gradient -->
                <div class="metric-range mt-2 hidden" data-key="${key}">
                    <div class="flex justify-between text-[8px] font-bold leading-none mb-1">
                        <span class="label-left"></span>
                        <span class="label-right"></span>
                    </div>

                    <div class="relative h-1.5 rounded-full bar">
                        <div class="fill"></div>
                    </div>
                </div>
                `;

            metricsCards.appendChild(div);

            setCardValue(key, value, min, max);
        })
    }

    function Card1(sensors) {
        // code ...
    }
    function Card2(sensors) {
        // code ...
    }
    function Card3(costs) {
        // code ...
    }
    function Card4(costs) {
        // code ...
    }


    let doChart = null;

    async function loadGraphsensorById() {
        const loading = document.getElementById('do-loading');

        try {
            const data = Object.values(sensors).find(
                s => s.monitor_id.toString() === sensor_select.toString()
            );
            console.log(data);


            console.log('ðŸ“Š DO Trend API Response:', data);


            if (!data || !data.logs || data.logs.length === 0) {
                console.warn('âš ï¸ à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥ ' + data.monitor_name);
                renderDoChart([], []);
                return;
            }

            const labels = data.logs.map(p => {
                const d = new Date(p.createtime);
                return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
            });

            const values = data.logs.map(p => parseFloat(p.data_value));

            renderDoChart(labels, values);

        } catch (err) {
            console.error('âŒ loadDoTrendData error:', err);
            renderDoChart([], []);
        } finally {
            if (loading) loading.classList.add('hidden');
        }
    }

    function renderDoChart(labels, values) {
        const ctx = document.getElementById('doTrendChart');
        if (!ctx) return;

        if (doChart) {
            doChart.destroy();
        }

        // Adjust font sizes based on screen width
        const screenWidth = window.innerWidth;
        let fontSize = 9;
        if (screenWidth >= 3840) fontSize = 18;
        else if (screenWidth >= 1920) fontSize = 12;

        doChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'DO (mg/L)',
                    data: values,
                    borderColor: '#ff8021',
                    backgroundColor: 'rgba(255,128,33,0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: screenWidth >= 3840 ? 4 : 2,
                    pointBackgroundColor: '#ff8021'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ` ${ctx.parsed.y.toFixed(2)} mg/L`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c',
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        beginAtZero: true,
                        // max: 10,
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c',
                            callback: v => v.toFixed(1)
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                }
            }
        });
    }

    async function loadMarketPriceTrend() {
        const loading = document.getElementById('price-loading');

        try {
            const res = await fetch('/dashboard/api/market_price_Tred.php', {
                cache: 'no-store'
            });
            const raw = await res.json();

            console.log('ðŸ“ˆ price trend raw:', raw);

            if (!Array.isArray(raw) || raw.length === 0) return;

            const labels = raw.map(r => r.event_month);

            const price50 = raw
                .filter(r => r.data_table_id === "19")
                .map(r => Number(r.event_price));

            const price70 = raw
                .filter(r => r.data_table_id === "20")
                .map(r => Number(r.event_price));

            renderMarketPriceChart(labels, price50, price70);

        } catch (err) {
            console.error('âŒ price trend error:', err);
        } finally {
            if (loading) loading.classList.add('hidden');
        }
    }

    let marketPriceChart;

    function renderMarketPriceChart(labels, price50, price70) {
        const ctx = document.getElementById('marketPriceChart');
        if (!ctx) return;

        if (marketPriceChart) {
            marketPriceChart.destroy();
        }

        // Adjust font sizes based on screen width
        const screenWidth = window.innerWidth;
        let fontSize = 10;
        if (screenWidth >= 3840) fontSize = 20;
        else if (screenWidth >= 1920) fontSize = 14;

        marketPriceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: '50 à¸•à¸±à¸§/à¸à¸.',
                    data: price50,
                    borderColor: '#ff8021',
                    backgroundColor: 'rgba(255,128,33,0.15)',
                    tension: 0.35,
                    fill: true,
                    pointRadius: screenWidth >= 3840 ? 5 : 2.5
                },
                {
                    label: '70 à¸•à¸±à¸§/à¸à¸.',
                    data: price70,
                    borderColor: 'rgba(255,128,33,0.4)',
                    backgroundColor: 'rgba(255,128,33,0.08)',
                    tension: 0.35,
                    fill: true,
                    pointRadius: screenWidth >= 3840 ? 4 : 2
                }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ` ${ctx.raw} à¸šà¸²à¸—/à¸à¸.`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c'
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c',
                            callback: v => v + ' à¸¿'
                        }
                    }
                }
            }
        });
    }


</script>