<!-- JavaScript -->
<script>
    const thaiMonths = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
    const today = new Date();
    const formattedDate = `${today.getDate()} ${thaiMonths[today.getMonth()]} ${today.getFullYear() + 543}`;
    document.getElementById('start-date').textContent = formattedDate;

    document.addEventListener('DOMContentLoaded', () => {
        loadSensorData();
        loadFeedingInfo();
        loadResourceToday();
        loadDoTrendData();

        setInterval(() => {
            loadSensorData();
            loadFeedingInfo();
            loadResourceToday();
            loadDoTrendData();
        }, 30000);
    });

    async function loadSensorData() {
        try {
            const res = await fetch('/dashboard/api/generate_sensor.php');
            const rows = await res.json();

            console.log('‚úÖ raw sensor data:', rows);

            const sensor = {};
            rows.forEach(item => {
                if (!item.divice_name) return;
                sensor[item.divice_name.toLowerCase()] = parseFloat(item.datax_value);
            });

            console.log('‚úÖ mapped sensor:', sensor);

            setCardValue('do', sensor.do);
            setCardValue('ph', sensor.ph);
            setCardValue('ec', sensor.ec);
            setCardValue('temp', sensor.temp);
            setCardValue('nh3', sensor.nh3 ?? null);

        } catch (err) {
            console.error('‚ùå loadSensorData error:', err);
        }
    }

    function setBadge(statusEl, text, type) {
        const map = {
            success: 'status px-2 py-0.5 rounded-full bg-green-100 text-green-600 text-[9px] font-bold uppercase',
            warning: 'status px-2 py-0.5 rounded-full bg-yellow-100 text-yellow-700 text-[9px] font-bold uppercase',
            danger: 'status px-2 py-0.5 rounded-full bg-red-100 text-red-600 text-[9px] font-bold uppercase',
            info: 'status px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-[9px] font-bold uppercase',
            na: 'status px-2 py-0.5 rounded-full bg-stone-100 text-stone-500 text-[9px] font-bold uppercase',
            orange: 'status px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 text-[9px] font-bold uppercase',
        };

        statusEl.textContent = text;
        statusEl.className = map[type] || map.na;
    }

    function getStatusByKey(key, v) {
        if (key === 'do') {
            if (v >= 5.0 && v <= 7.0) return { text: '‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', type: 'success' };
            if (v > 4.0) return { text: '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', type: 'success' };
            if (v >= 3.0 && v <= 4.0) return { text: '‡πÑ‡∏°‡πà‡∏î‡∏µ', type: 'warning' };
            return { text: '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢', type: 'danger' };
        }

        if (key === 'ph') {
            if (v >= 7.0 && v <= 8.5) return { text: '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', type: 'success' };
            if (v < 6.5) return { text: '‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏≥‡∏ö‡∏≤‡∏Å', type: 'orange' };
            if (v > 9.0) return { text: '‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢', type: 'danger' };
            return { text: '‡∏Ñ‡∏ß‡∏£‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π', type: 'warning' };
        }

        if (key === 'ec') {
            if (v >= 23000 && v <= 45000) return { text: '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', type: 'success' };
            if (v < 23000) return { text: '‡∏ï‡πà‡∏≥', type: 'info' };
            return { text: '‡∏™‡∏π‡∏á', type: 'danger' };
        }

        if (key === 'temp') {
            if (v >= 28 && v <= 32) return { text: '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°', type: 'success' };
            if (v < 28) return { text: '‡∏ï‡πà‡∏≥', type: 'info' };
            return { text: '‡∏™‡∏π‡∏á', type: 'danger' };
        }

        return { text: 'N/A', type: 'na' };
    }

    function setCardValue(key, value) {
        const card = document.getElementById(`card-${key}`);
        if (!card) return;

        const valueEl = card.querySelector('.value');
        const statusEl = card.querySelector('.status');

        if (value === null || value === undefined || isNaN(value)) {
            valueEl.textContent = '--';
            setBadge(statusEl, 'N/A', 'na');
            return;
        }

        const v = Number(value);

        valueEl.textContent = v.toLocaleString('en-US', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 2
        });

        const st = getStatusByKey(key, v);
        setBadge(statusEl, st.text, st.type);

        updateMetricBar(key, v);
    }

    const BAR_CONFIG = {
        do: {
            min: 0,
            max: 7,
            leftLabel: '3.0',
            rightLabel: '7.0',
            leftColor: '#C73434',
            rightColor: '#198754',
        },
        ph: {
            min: 1,
            max: 14,
            leftLabel: '1',
            rightLabel: '14',
            leftColor: '#7F1D1D',
            rightColor: '#581C87',
        },
        ec: {
            min: 15000,
            max: 50000,
            leftLabel: '23K',
            rightLabel: '45K',
            leftColor: '#3B82F6',
            rightColor: '#198754',
        },
        temp: {
            min: 25,
            max: 35,
            leftLabel: '28¬∞C',
            rightLabel: '32¬∞C',
            leftColor: '#3B82F6',
            rightColor: '#F97316',
        },
    };

    function initMetricBars() {
        document.querySelectorAll('.metric-range').forEach(wrap => {
            const key = wrap.dataset.key;
            const cfg = BAR_CONFIG[key];
            if (!cfg) return;

            wrap.classList.remove('hidden');

            const left = wrap.querySelector('.label-left');
            const right = wrap.querySelector('.label-right');
            left.textContent = cfg.leftLabel || '';
            right.textContent = cfg.rightLabel || '';
            left.style.color = cfg.leftColor || '#C73434';
            right.style.color = cfg.rightColor || '#198754';

            const fill = wrap.querySelector('.fill');
            if (fill) fill.style.clipPath = 'inset(0 100% 0 0)';
        });
    }

    function updateMetricBar(key, value) {
        const cfg = BAR_CONFIG[key];
        if (!cfg) return;

        const wrap = document.querySelector(`.metric-range[data-key="${key}"]`);
        if (!wrap) return;

        const fill = wrap.querySelector('.fill');

        if (value === null || value === undefined || isNaN(value)) {
            if (fill) fill.style.clipPath = 'inset(0 100% 0 0)';
            return;
        }

        const v = Number(value);
        const pct = ((v - cfg.min) / (cfg.max - cfg.min)) * 100;
        const safePct = clamp(pct, 0, 100);

        if (fill) {
            fill.style.clipPath = `inset(0 ${100 - safePct}% 0 0)`;
        }
    }

    function clamp(n, min, max) {
        return Math.max(min, Math.min(max, n));
    }

    async function loadFeedingInfo() {
        const mealsEl = document.getElementById('feeding-meals');
        const increaseEl = document.getElementById('feeding-increase');
        const totalEl = document.getElementById('feeding-total');

        if (!mealsEl || !increaseEl || !totalEl) return;

        mealsEl.textContent = '--';
        increaseEl.textContent = '--';
        totalEl.textContent = '--';

        try {
            const res = await fetch('/dashboard/api/food_preparation.php', {
                cache: 'no-store'
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const rows = await res.json();

            if (!Array.isArray(rows) || rows.length === 0) {
                throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }

            rows.forEach(item => {
                const label = (item.label || '').toLowerCase();
                const value = item.value || '--';

                if (label.includes('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏∑‡πâ‡∏≠') || item.id == 10) {
                    mealsEl.textContent = value;
                } else if (label.includes('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏°‡∏∑‡πâ‡∏≠') || item.id == 15) {
                    increaseEl.textContent = value;
                } else if (label.includes('‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏£‡∏ß‡∏°') || item.id == 14) {
                    totalEl.textContent = value;
                }
            });

        } catch (err) {
            console.error('‚ùå loadFeedingInfo error:', err);
            mealsEl.textContent = 'N/A';
            increaseEl.textContent = 'N/A';
            totalEl.textContent = 'N/A';
        }
    }

    let resourceTimer = null;
    let resourceIndex = 0;
    let resourceTotal = 0;

    async function loadResourceToday() {
        const box = document.getElementById("resource-info");
        if (!box) return;

        box.classList.remove("grid", "grid-cols-2", "gap-2");
        box.classList.add(
            "flex",
            "overflow-x-auto",
            "snap-x",
            "snap-mandatory",
            "scroll-smooth",
            "no-scrollbar"
        );

        if (typeof stopResourceAutoSlide === "function") stopResourceAutoSlide();

        box.innerHTML = `
                <div class="w-full shrink-0 snap-start flex items-center justify-center">
                <span class="text-xs text-stone-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                </div>
            `;

        try {
            const res = await fetch("/dashboard/api/resource_to_day.php", {
                cache: "no-store"
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);

            const data = await res.json();

            const item = Array.isArray(data) ?
                data.find(x => String(x.id) === "1") :
                (String(data?.id) === "1" ? data : null);

            if (!item) {
                box.innerHTML = `
                    <div class="w-full shrink-0 snap-start flex items-center justify-center">
                    <span class="text-xs text-stone-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• id=1</span>
                    </div>
                `;
                return;
            }

            box.innerHTML = `
                <div class="w-full h-full shrink-0 snap-start">
                    <div class="w-full h-full">
                    ${renderResourceCard(item)}
                    </div>
                </div>
                `;

        } catch (err) {
            console.error("‚ùå loadResourceToday error:", err);
            box.innerHTML = `
                <div class="w-full shrink-0 snap-start flex items-center justify-center">
                    <span class="text-xs text-red-500 font-semibold">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
                </div>
                `;
        }
    }

    function stopResourceAutoSlide() {
        const box = document.getElementById("resource-info");
        if (box) box.removeEventListener("scroll", onResourceScroll);

        if (resourceTimer) {
            clearInterval(resourceTimer);
            resourceTimer = null;
        }
    }

    function onResourceScroll() {
        const box = document.getElementById("resource-info");
        if (!box) return;

        const w = box.clientWidth || 1;
        const idx = Math.round(box.scrollLeft / w);
        if (Number.isFinite(idx)) resourceIndex = clamp(idx, 0, Math.max(0, resourceTotal - 1));
    }

    function renderResourceCard(item) {
        const id = item.id ?? "-";
        const water = toNumber(item.water_value);
        const waterUnit = item.water_unit ?? "m3";
        const elec = toNumber(item.electric_value);
        const elecUnit = item.electric_unit ?? "kWh";
        const status = String(item.status ?? "NORMAL").toUpperCase();
        const updated = item.updated_at ?? "";

        return `
                <div class=" ">
                <div class="flex flex-row-reverse mb-2">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="rounded-lg bg-gray-100 border border-stone-200 p-2">
                    <div class="text-[10px] text-stone-500 font-semibold text-center">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤</div>
                    <div class="text-sm text-center font-extrabold ${water === 0 ? "text-stone-400" : "text-stone-800"}">
                        ${formatNumber(water)} <span class="text-[10px] font-bold text-stone-500">${escapeHtml(waterUnit)}</span>
                    </div>
                    </div>

                    <div class="rounded-lg bg-gray-100 border border-stone-200 p-2">
                    <div class="text-[10px] text-stone-500 font-semibold text-center">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</div>
                    <div class="text-sm text-center font-extrabold ${elec === 0 ? "text-stone-400" : "text-stone-800"}">
                        ${formatNumber(elec)} <span class="text-[10px] font-bold text-stone-500">${escapeHtml(elecUnit)}</span>
                    </div>
                    </div>
                </div>

                <div class="mt-2 text-[9px] text-stone-400 font-semibold text-end">
                    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${escapeHtml(updated)}
                </div>
                </div>
            `;
    }

    function toNumber(v) {
        const n = parseFloat(v);
        return Number.isFinite(n) ? n : 0;
    }

    function formatNumber(n) {
        return (Number.isFinite(n) ? n : 0).toFixed(1);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    let doChart = null;

    async function loadDoTrendData() {
        const loading = document.getElementById('do-loading');

        try {
            const res = await fetch('/dashboard/api/monitor_trend.php', {
                cache: 'no-store'
            });
            const data = await res.json();

            console.log('üìä DO Trend API Response:', data);

            const doData = data.find(item => item.device_id === 2);

            if (!doData || !doData.points || doData.points.length === 0) {
                console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• DO');
                renderDoChart([], []);
                return;
            }

            const labels = doData.points.map(p => {
                const d = new Date(p.time);
                return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
            });

            const values = doData.points.map(p => parseFloat(p.value));

            renderDoChart(labels, values);

        } catch (err) {
            console.error('‚ùå loadDoTrendData error:', err);
            renderDoChart([], []);
        } finally {
            if (loading) loading.classList.add('hidden');
        }
    }

    function renderDoChart(labels, values) {
        const ctx = document.getElementById('doTrendChart');
        if (!ctx) return;

        if (doChart) {
            doChart.destroy();
        }

        // Adjust font sizes based on screen width
        const screenWidth = window.innerWidth;
        let fontSize = 9;
        if (screenWidth >= 3840) fontSize = 18;
        else if (screenWidth >= 1920) fontSize = 12;

        doChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'DO (mg/L)',
                    data: values,
                    borderColor: '#ff8021',
                    backgroundColor: 'rgba(255,128,33,0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: screenWidth >= 3840 ? 4 : 2,
                    pointBackgroundColor: '#ff8021'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ` ${ctx.parsed.y.toFixed(2)} mg/L`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c',
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 8
                        }
                    },
                    y: {
                        beginAtZero: true,
                        max: 10,
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c',
                            callback: v => v.toFixed(1)
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        }
                    }
                }
            }
        });
    }

    async function loadMarketPriceTrend() {
        const loading = document.getElementById('price-loading');

        try {
            const res = await fetch('/dashboard/api/market_price_Tred.php', {
                cache: 'no-store'
            });
            const raw = await res.json();

            console.log('üìà price trend raw:', raw);

            if (!Array.isArray(raw) || raw.length === 0) return;

            const labels = raw.map(r => r.event_month);

            const price50 = raw
                .filter(r => r.data_table_id === "19")
                .map(r => Number(r.event_price));

            const price70 = raw
                .filter(r => r.data_table_id === "20")
                .map(r => Number(r.event_price));

            renderMarketPriceChart(labels, price50, price70);

        } catch (err) {
            console.error('‚ùå price trend error:', err);
        } finally {
            if (loading) loading.classList.add('hidden');
        }
    }

    let marketPriceChart;

    function renderMarketPriceChart(labels, price50, price70) {
        const ctx = document.getElementById('marketPriceChart');
        if (!ctx) return;

        if (marketPriceChart) {
            marketPriceChart.destroy();
        }

        // Adjust font sizes based on screen width
        const screenWidth = window.innerWidth;
        let fontSize = 10;
        if (screenWidth >= 3840) fontSize = 20;
        else if (screenWidth >= 1920) fontSize = 14;

        marketPriceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: '50 ‡∏ï‡∏±‡∏ß/‡∏Å‡∏Å.',
                    data: price50,
                    borderColor: '#ff8021',
                    backgroundColor: 'rgba(255,128,33,0.15)',
                    tension: 0.35,
                    fill: true,
                    pointRadius: screenWidth >= 3840 ? 5 : 2.5
                },
                {
                    label: '70 ‡∏ï‡∏±‡∏ß/‡∏Å‡∏Å.',
                    data: price70,
                    borderColor: 'rgba(255,128,33,0.4)',
                    backgroundColor: 'rgba(255,128,33,0.08)',
                    tension: 0.35,
                    fill: true,
                    pointRadius: screenWidth >= 3840 ? 4 : 2
                }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ` ${ctx.raw} ‡∏ö‡∏≤‡∏ó/‡∏Å‡∏Å.`
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c'
                        }
                    },
                    y: {
                        ticks: {
                            font: {
                                size: fontSize
                            },
                            color: '#78716c',
                            callback: v => v + ' ‡∏ø'
                        }
                    }
                }
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        initMetricBars();
        loadMarketPriceTrend();
    });
</script>