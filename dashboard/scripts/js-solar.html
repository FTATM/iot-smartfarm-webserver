<!-- JavaScript -->
<script>
    let isLoading = true;
    let sensor_select = 0;

    const Sensors_realtime = ["Voltage_S", "Current_S", "Power_S", "Voltage_L", "Current_L", "Power_L"];
    const Sensors_name_left = [];
    const Sensors_name_right = [];
    const market_name = "solar";     //name market example => solar, shrimp, indoor, outdoor
    const type = "demand,price";             //multi type example => demand,price

    document.addEventListener('DOMContentLoaded', async () => {
        await loadSensorData();
        await SensorsLeft();
        await SensorsRight();
        await Card1();
        await Card2();
        await Card3();
        await Card4();

        await loadGraphMarketById();
        initMetricBars();
        isLoading = false;
        // setInterval(async () => {
        //     await loadSensorData();
        //     await loadGraphSensorById();
        // }, 10000);



    });
    async function loadSensorData() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_realtime
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            Create_sensorCard(Sensors_realtime, sensors);

            loadGraphSensorById(sensors);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function SensorsLeft() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_name_left
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            console.log("Left");
            console.log(sensors);

            SetCardsBynames(Sensors_name_left, sensors, 'left');

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function SensorsRight() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_name_right
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            console.log("right");
            console.log(sensors);

            SetCardsBynames(Sensors_name_right, sensors, 'right');

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    function Create_sensorCard(sensor_names, sensors) {
        let metricsCards = document.getElementById('metrics-cards');
        metricsCards.innerHTML = "";
        Object.values(sensor_names).forEach((s) => {
            const row = sensors[s] || { "min": 0, "max": 0, "unit": "--", "logs": [] };
            const min = row['min'] || 0;
            const max = row['max'] || 1;
            let value = row.logs.length > 0 ? row.logs[0].data_value : "--";
            let div = document.createElement('div');
            div.id = `card-${s}`;
            div.className = "bg-white rounded-2xl p-4 border border-stone-200 shadow-sm flex flex-col hover:ring-2 hover:ring-orange-400 transition-all duration-20 shrink-0";
            div.innerHTML = `
                <div class="w-full flex justify-between items-center">
                    <span class="text-[1vw] font-bold text-stone-500 uppercase tracking-widest">
                        ${s}
                    </span>
                    <span class="px-2 py-0.5 rounded-full bg-stone-100 text-stone-500 text-[1vw] font-bold uppercase status">
                        --
                    </span>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    <div class="flex items-baseline gap-1">
                        <span class="text-[1.5vw] font-black text-black value">
                            ${value}
                        </span>
                        <span class="text-[1vw] font-bold text-stone-400">
                            ${row.unit}
                        </span>
                    </div>
                </div>

                <!-- Range Bar with Fixed Gradient -->
                <div class="metric-range mt-2 hidden" data-key="${s}" data-min="${min}" data-max="${max}">
                    <div class="flex justify-between text-[1vw] font-bold leading-none mb-1">
                        <span class="label-left"></span>
                        <span class="label-right"></span>
                    </div>

                    <div class="relative h-1.5 rounded-full bar">
                        <div class="fill"></div>
                    </div>
                </div>
                `;

            if (row['unit'] !== "--") {
                div.onclick = () => {
                    console.log("Select sensor : " + row.monitor_name);
                    sensor_select = row.monitor_id;
                    loadGraphSensorById(sensors);
                }
            }

            metricsCards.appendChild(div);

            setCardValue(s, value, min, max);

            if (sensor_select == 0 && row.monitor_id) {
                sensor_select = row.monitor_id;
            }
        })
    }

    function calculateEnergySummary(dataS, dataL) {

        const now = new Date();

        const ranges = {
            "1hr": 1,
            "3hr": 3,
            "12hr": 12
        };

        const result = {
            supply: {},
            load: {},
            balance: {}
        };

        function sumByHours(logs, hours) {
            const pastTime = new Date(now.getTime() - hours * 60 * 60 * 1000);

            return logs
                .filter(log => new Date(log.createtime) >= pastTime)
                .reduce((sum, log) => sum + parseFloat(log.data_value), 0);
        }

        Object.entries(ranges).forEach(([key, hours]) => {

            const supplySum = sumByHours(dataS.logs || [], hours);
            const loadSum = sumByHours(dataL.logs || [], hours);

            result.supply[key] = supplySum;
            result.load[key] = loadSum;
            result.balance[key] = supplySum - loadSum;
        });

        return result;
    }

    function renderEnergySummary(summary) {

        // helper แปลงเป็นทศนิยม 2 ตำแหน่ง
        const format = (val) => {
            if (isNaN(val)) return "--";
            return parseFloat(val).toFixed(1);
        };

        // Supply
        document.getElementById("supply-1h").textContent = format(summary.supply["1hr"]);
        document.getElementById("supply-3h").textContent = format(summary.supply["3hr"]);
        document.getElementById("supply-12h").textContent = format(summary.supply["12hr"]);

        // Load
        document.getElementById("load-1h").textContent = format(summary.load["1hr"]);
        document.getElementById("load-3h").textContent = format(summary.load["3hr"]);
        document.getElementById("load-12h").textContent = format(summary.load["12hr"]);

        // Balance
        document.getElementById("balance-1h").textContent = format(summary.balance["1hr"]);
        document.getElementById("balance-3h").textContent = format(summary.balance["3hr"]);
        document.getElementById("balance-12h").textContent = format(summary.balance["12hr"]);
    }

    async function Card1() {
        console.log("Card 1");
        const pwrMeterSensor = ["Voltage", "Current", "Power", "Energy"];
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: pwrMeterSensor
                    })
                }
            );
            const data = await res.json();
            const pwrsensors = data['sensors'];

            const voltageData = (pwrsensors.Voltage?.logs || []).map(log =>
                parseFloat(log.data_value)
            );
            const currentData = (pwrsensors.Current?.logs || []).map(log =>
                parseFloat(log.data_value)
            );
            const powerData = (pwrsensors.Power?.logs || []).map(log =>
                parseFloat(log.data_value)
            );
            const energyData = (pwrsensors.Energy?.logs || []).map(log =>
                parseFloat(log.data_value)
            );

            const v = Avg(voltageData);
            const c = Avg(currentData);
            const p = Avg(powerData);
            const e = energyData[energyData.length - 1];

            const voltageEl = document.getElementById('pwrm-voltage');
            const currentEl = document.getElementById('pwrm-current');
            const powerEl = document.getElementById('pwrm-power');
            const energyEl = document.getElementById('pwrm-energy');

            voltageEl.textContent = v;
            currentEl.textContent = c;
            powerEl.textContent = p;
            energyEl.textContent = e;
        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }


    }

    async function Card2() {
        console.log("Card 2");
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_realtime
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            const sensors_L = Object.fromEntries(
                Object.entries(sensors).filter(([key]) => key.endsWith('_L'))
            );

            const sensors_S = Object.fromEntries(
                Object.entries(sensors).filter(([key]) => key.endsWith('_S'))
            );
            const summary = calculateEnergySummary(sensors_S.Voltage_S, sensors_L.Voltage_L);

            renderEnergySummary(summary);
        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function Card3() {
        console.log("Card 3");
        try {
            const res = await fetch('../../api-website/fetch_Costs.php?bid=1');
            const raw = await res.json();
            const costs = raw['data'];

            const initialEl = document.getElementById('initial-capital');
            const refundEl = document.getElementById('refunded');
            const remainEl = document.getElementById('remaining');

            const income = Number(costs[0]?.income) || 0;
            const expense = Number(costs[0]?.expense) || 0;
            const remain = income - expense;

            initialEl.textContent = expense;
            refundEl.textContent = income;
            remainEl.textContent = remain;

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }

    }
    async function Card4() {
        console.log("Card 4");
        try {
            const res = await fetch('../../api-website/fetch_expenseBycategory.php?bid=1');
            const raw = await res.json();
            const expense = raw['data'];


            const hardwareEl = document.getElementById('expense-hardware');
            const infrastructureEl = document.getElementById('expense-infrastructure');
            const miscellaneousEl = document.getElementById('expense-miscellaneous');
            const totalEl = document.getElementById('expense-total');

            hardware = Number(expense[0]?.hardware) || 0;
            infrastructure = Number(expense[0]?.infrastructure) || 0;
            miscellaneous = Number(expense[0]?.miscellaneous) || 0;

            hardwareEl.textContent = hardware;
            infrastructureEl.textContent = infrastructure;
            miscellaneousEl.textContent = miscellaneous;
            totalEl.textContent = hardware + infrastructure + miscellaneous;


        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

</script>