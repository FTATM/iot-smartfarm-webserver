<!-- JavaScript -->
<script>
    let isLoading = true;
    let sensor_select = 0;

    const Sensors_realtime = ["Tempurature", "PH", "Ammonia", "Oxygen", "Co2", "Lux"];
    const Sensors_name_left = ["manual/Auto", "SW.FAN", "SW.FOG"];
    const Sensors_name_right = ["SW.CH1", "SW.CH2", "SW.WaaT"];
    const market_name = "chicken";    //name market example => solar, shrimp, indoor, outdoor
    const type = "price";             //multi type example => demand,price

    // Adjust font sizes based on screen width
    document.addEventListener('DOMContentLoaded', async () => {

        await loadSensorData();
        await SensorsLeft();
        await SensorsRight();
        await Card1();
        await Card2();
        await Card3();
        await Card4();

        await loadGraphMarketById();

        isLoading = false;
        // setInterval(async () => {
        //     await loadSensorData();
        //     await loadGraphSensorById();
        // }, 10000);

    });

    async function loadSensorData() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_realtime
                    })
                }
            );
            const data = await res.json();
            console.log("===== load sensors realtime =======");
            const sensors = data['sensors'];
            console.log(sensors);

            Create_sensorCard(Sensors_realtime, sensors);

            loadGraphSensorById(sensors);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function SensorsLeft() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_name_left
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            console.log("Left");
            console.log(sensors);

            SetCardsBynames(Sensors_name_left, sensors, 'left');

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function SensorsRight() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_name_right
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            console.log("right");
            console.log(sensors);

            SetCardsBynames(Sensors_name_right, sensors, 'right');

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    function Create_sensorCard(sensor_names, sensors) {
        let metricsCards = document.getElementById('metrics-cards');
        metricsCards.innerHTML = "";
        Object.values(sensor_names).forEach((s) => {
            const row = sensors[s] || { "min": 0, "max": 0, "unit": "--", "logs": [] };
            const min = row['min'] || 0;
            const max = row['max'] || 1;
            let value = row.logs.length > 0 ? row.logs[0].data_value : "--";
            let div = document.createElement('div');
            div.id = `card-${s}`;
            div.className = "bg-white rounded-2xl p-4 border border-stone-200 shadow-sm flex flex-col hover:ring-2 hover:ring-orange-400 transition-all duration-20 shrink-0";
            div.innerHTML = `
                <div class="w-full flex justify-between items-center">
                    <span class="text-[1vw] font-bold text-stone-500 uppercase tracking-widest">
                        ${s}
                    </span>
                    <span class="px-2 py-0.5 rounded-full bg-stone-100 text-stone-500 text-[1vw] font-bold uppercase status">
                        --
                    </span>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    <div class="flex items-baseline gap-1">
                        <span class="text-[1.5vw] font-black text-black value">
                            ${value}
                        </span>
                        <span class="text-[1vw] font-bold text-stone-400">
                            ${row.unit}
                        </span>
                    </div>
                </div>

                <!-- Range Bar with Fixed Gradient -->
                <div class="metric-range mt-2 hidden" data-key="${s}" data-min="${min}" data-max="${max}">
                    <div class="flex justify-between text-[1vw] font-bold leading-none mb-1">
                        <span class="label-left"></span>
                        <span class="label-right"></span>
                    </div>

                    <div class="relative h-1.5 rounded-full bar">
                        <div class="fill"></div>
                    </div>
                </div>
                `;

            if (row['unit'] !== "--") {
                div.onclick = () => {
                    console.log("Select sensor : " + row.monitor_name);
                    sensor_select = row.monitor_id;
                    loadGraphSensorById(sensors);
                }
            }

            metricsCards.appendChild(div);

            setCardValue(s, value, min, max);

            if (sensor_select == 0 && row.monitor_id) {
                sensor_select = row.monitor_id;
            }
        })

    }

    async function Card1() {
        console.log("Card 1");
        const table_type = 1;     //Watch table id in 
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type + "&aDay=" + diff.day);
            const raw = await res.json();
            const table = Object.values(raw.data);

            const mealsCount = table[0].value;
            const volumeMeal = table[0].children[0]['value'];
            const totalMealperDay = (toNumber(mealsCount) * toNumber(volumeMeal)) || "-";

            SetValueInHTMLById('meals-count', mealsCount);
            SetValueInHTMLById('volume-meal', volumeMeal);
            SetValueInHTMLById('total-meal-per-day', totalMealperDay);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function Card2() {
        console.log("Card 2");
        const table_type_humidity = 5;     //Watch table id in database
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type_humidity + "&aDay=" + diff.day);
            const raw = await res.json();
            const humidityTable = Object.values(raw.data);

            const humidity = humidityTable[0].value;

            SetValueInHTMLById('humidity', humidity + "%");

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }


        // =============== Light ==============
        const table_type_light = 4;     //Watch table id in database
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type_light + "&aDay=" + diff.day);
            const raw = await res.json();
            const LuminanceTable = Object.values(raw.data);
            console.log(LuminanceTable);

            const totalhours = LuminanceTable[0].value;
            const lighttime = LuminanceTable[0].children[0].value;
            const luminance = LuminanceTable[0].children[1].value;

            SetValueInHTMLById('total-hours', totalhours);
            SetValueInHTMLById('light-time', lighttime);
            SetValueInHTMLById('light-recommentation', luminance);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }

    }

    async function Card3() {
        calculateElectricityAndWater('card-3');
    }

    async function Card4() {
        let expense = [];
        let categories = [];
        const category_type = 'expense';
        try {
            const res = await fetch('../../api-website/fetch_expenses.php');
            const raw = await res.json();
            expense = raw['data'];

            const resincome = await fetch('../../api-website/fetch_incomes.php');
            const rawincome = await resincome.json();
            income = rawincome['data'];

            const rescat = await fetch('../../api-website/fetch_categories.php?type=' + category_type);
            const raw3 = await rescat.json();
            categories = raw3['data'];

        } catch (err) {
            console.error('❌ fetch expenses error:', err);

        }

        const categoryMapex = {};
        const categoryMapin = {};

        expense.forEach(item => {
            if (!categoryMapex[item.category_id]) {
                categoryMapex[item.category_id] = 0;
            }
            categoryMapex[item.category_id] += Number(item.amount);
        });
        income.forEach(item => {
            if (!categoryMapin[item.category_id]) {
                categoryMapin[item.category_id] = 0;
            }
            categoryMapin[item.category_id] += Number(item.amount);
        });

        const sortedex = Object.entries(categoryMapex)
            .sort((a, b) => b[1] - a[1]);

        const totalin = Object.values(categoryMapin)
            .reduce((sum, value) => sum + value, 0);

        const totalex = sortedex.reduce((sum, c) => sum + c[1], 0);
        const top3ex = sortedex.slice(0, 3);

        SetValueInHTMLById('card-4-expense', '฿' + totalex);
        SetValueInHTMLById('card-4-income', '฿' + totalin);
        SetValueInHTMLById('card-4-remain', '฿' + (totalin - totalex));

        const listEl = document.getElementById("card-4-list");

        listEl.innerHTML = "";

        top3ex.forEach((item, index) => {

            const categoryId = item[0];
            const amount = item[1];
            const percent = ((amount / totalex) * 100).toFixed(1);

            let categoryName = categories.find(c => c['id'].toString() == categoryId.toString())?.name || "--";

            listEl.innerHTML += `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-[1.5vw] h-[1.5vw] rounded-full bg-blue-100 flex items-center justify-center font-bold text-[0.5vw]">
                        #${index + 1}
                    </div>
                    <div>
                        <p class="text-[0.75vw] font-semibold">${categoryName}</p>
                        <p class="text-[0.5vw] text-slate-400">ID: ${categoryId}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-[0.75vw] font-bold">฿${formatNumber(amount)}</p>
                    <p class="text-[0.5vw] text-slate-400">${percent}%</p>
                </div>
            </div>
            `;
        });
    }
</script>