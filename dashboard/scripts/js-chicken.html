<!-- JavaScript -->
<script>
    let isLoading = true;
    let sensor_select = 0;

    const Sensors_realtime = ["Tempurature", "PH", "Ammonia", "Oxygen", "Co2", "Lux"];
    const Sensors_name_left = ["manual/Auto", "SW.FAN", "SW.FOG"];
    const Sensors_name_right = ["SW.CH1", "SW.CH2", "SW.WaaT"];
    const market_name = "chicken";    //name market example => solar, shrimp, indoor, outdoor
    const type = "price";             //multi type example => demand,price

    // Adjust font sizes based on screen width
    document.addEventListener('DOMContentLoaded', async () => {

        await loadSensorData();
        await SensorsLeft();
        await SensorsRight();
        await Card1();
        await Card2();
        await Card3();
        await Card4();

        await loadGraphMarketById();

        isLoading = false;
        // setInterval(async () => {
        //     await loadSensorData();
        //     await loadGraphSensorById();
        // }, 10000);

    });

    async function loadSensorData() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_realtime
                    })
                }
            );
            const data = await res.json();
            console.log("===== load sensors realtime =======");
            const sensors = data['sensors'];
            console.log(sensors);

            Create_sensorCard(Sensors_realtime, sensors);

            loadGraphSensorById(sensors);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function SensorsLeft() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_name_left
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            console.log("Left");
            console.log(sensors);

            SetCardsBynames(Sensors_name_left, sensors, 'left');

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function SensorsRight() {
        try {
            const res = await fetch('../../api-website/plot_sensor_log_multiple.php',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sensorLog: Sensors_name_right
                    })
                }
            );
            const data = await res.json();
            const sensors = data['sensors'];

            console.log("right");
            console.log(sensors);

            SetCardsBynames(Sensors_name_right, sensors, 'right');

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    function Create_sensorCard(sensor_names, sensors) {
        let metricsCards = document.getElementById('metrics-cards');
        metricsCards.innerHTML = "";
        Object.values(sensor_names).forEach((s) => {
            const row = sensors[s] || { "min": 0, "max": 0, "unit": "--", "logs": [] };
            const min = row['min'] || 0;
            const max = row['max'] || 1;
            let value = row.logs.length > 0 ? row.logs[0].data_value : "--";
            let div = document.createElement('div');
            div.id = `card-${s}`;
            div.className = "bg-white rounded-2xl p-4 border border-stone-200 shadow-sm flex flex-col hover:ring-2 hover:ring-orange-400 transition-all duration-20 shrink-0";
            div.innerHTML = `
                <div class="w-full flex justify-between items-center">
                    <span class="text-[1vw] font-bold text-stone-500 uppercase tracking-widest">
                        ${s}
                    </span>
                    <span class="px-2 py-0.5 rounded-full bg-stone-100 text-stone-500 text-[1vw] font-bold uppercase status">
                        --
                    </span>
                </div>
                <div class="flex-1 flex items-center justify-center">
                    <div class="flex items-baseline gap-1">
                        <span class="text-[1.5vw] font-black text-black value">
                            ${value}
                        </span>
                        <span class="text-[1vw] font-bold text-stone-400">
                            ${row.unit}
                        </span>
                    </div>
                </div>

                <!-- Range Bar with Fixed Gradient -->
                <div class="metric-range mt-2 hidden" data-key="${s}" data-min="${min}" data-max="${max}">
                    <div class="flex justify-between text-[1vw] font-bold leading-none mb-1">
                        <span class="label-left"></span>
                        <span class="label-right"></span>
                    </div>

                    <div class="relative h-1.5 rounded-full bar">
                        <div class="fill"></div>
                    </div>
                </div>
                `;

            if (row['unit'] !== "--") {
                div.onclick = () => {
                    console.log("Select sensor : " + row.monitor_name);
                    sensor_select = row.monitor_id;
                    loadGraphSensorById(sensors);
                }
            }

            metricsCards.appendChild(div);

            setCardValue(s, value, min, max);

            if (sensor_select == 0 && row.monitor_id) {
                sensor_select = row.monitor_id;
            }
        })

    }

    async function Card1() {
        console.log("Card 1");
        const table_type = 1;     //Watch table id in 
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type + "&aDay=" + diff.day);
            const raw = await res.json();
            const table = Object.values(raw.data);

            const mealsCount = table[0].value;
            const volumeMeal = table[0].children[0]['value'];
            const totalMealperDay = (toNumber(mealsCount) * toNumber(volumeMeal)) || "-";

            SetValueInHTMLById('meals-count', mealsCount);
            SetValueInHTMLById('volume-meal', volumeMeal);
            SetValueInHTMLById('total-meal-per-day', totalMealperDay);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function Card2() {
        console.log("Card 2");
        const table_type_humidity = 5;     //Watch table id in database
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type_humidity + "&aDay=" + diff.day);
            const raw = await res.json();
            const humidityTable = Object.values(raw.data);

            const humidity = humidityTable[0].value;

            SetValueInHTMLById('humidity', humidity + "%");

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }


        // =============== Light ==============
        const table_type_light = 4;     //Watch table id in database
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type_light + "&aDay=" + diff.day);
            const raw = await res.json();
            const LuminanceTable = Object.values(raw.data);
            console.log(LuminanceTable);

            const totalhours = LuminanceTable[0].value;
            const lighttime = LuminanceTable[0].children[0].value;
            const luminance = LuminanceTable[0].children[1].value;

            SetValueInHTMLById('total-hours', totalhours);
            SetValueInHTMLById('light-time', lighttime);
            SetValueInHTMLById('light-recommentation', luminance);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }

    }

    async function Card3() {
        try {
            const res = await fetch('../../api-website/fetch_expenseBycategory.php?bid=1');
            const raw = await res.json();
            const expense = raw['data'];


            const electricityEl = document.getElementById('electricity-usage');
            const waterEl = document.getElementById('water-usage');

            if (electricityEl) {
                electricityEl.style.fontSize = (fontSize * 2) + "px";
                electricity = Number(expense[0]?.electricity) || 0;
                electricityEl.textContent = electricity;
            }
            if (waterEl) {
                waterEl.style.fontSize = (fontSize * 2) + "px";
                water = Number(expense[0]?.water) || 0;
                waterEl.textContent = water;
            }

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }

    }

    async function Card4() {
        try {
            const res = await fetch('../../api-website/fetch_expenseBycategory.php?bid=1');
            const raw = await res.json();
            const expense = raw['data'];

            const electricity = Number(expense[0]?.electricity) || 0;
            const water = Number(expense[0]?.water) || 0;
            const hardware = Number(expense[0]?.hardware) || 0;
            const infrastructure = Number(expense[0]?.infrastructure) || 0;
            const miscellaneous = Number(expense[0]?.miscellaneous) || 0;
            const total = hardware + infrastructure + miscellaneous + electricity + water;

            SetValueInHTMLById('electricity-usage', electricity);
            SetValueInHTMLById('water-usage', water);
            SetValueInHTMLById('expense-hardware', hardware);
            SetValueInHTMLById('expense-infrastructure', infrastructure);
            SetValueInHTMLById('expense-miscellaneous', miscellaneous);
            SetValueInHTMLById('expense-total', total);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }
</script>