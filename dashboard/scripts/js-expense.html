<!-- JavaScript -->
<script>
    let datas = [];
    let branchs = [];
    let categories = [];
    let isLoading = true;
    let row_id_will_delete = 0;
    let sensor_select = 0;

    //Table
    let currentPage = 1;
    const rowsPerPage = Math.ceil(screenHeight * 0.008);
    let globalData = [];

    const branch_id = 1;
    const category_type = 'expense';
    const market_name = "";           //name market example => solar, shrimp, indoor, outdoor
    const type = "price";             //multi type example => demand,price

    // Adjust font sizes based on screen width
    document.addEventListener('DOMContentLoaded', async () => {

        await process();
        // await Card1();
        // await Card2();
        // await Card3();
        // await Card4();

        isLoading = false;
        // setInterval(async () => {
        // }, 10000);

    });

    async function process() {
        await initLoadData();
        await initHTML();
        await FilterDataForSearch(datas);
    }

    async function initLoadData() {
        try {
            const resdata = await fetch('../../api-website/fetch_expenses.php');
            const raw1 = await resdata.json();
            datas = raw1['data'];
            const resbr = await fetch('../../api-website/fetch_branch.php');
            const raw2 = await resbr.json();
            branchs = raw2['data'];
            const rescat = await fetch('../../api-website/fetch_categories.php?type=' + category_type);
            const raw3 = await rescat.json();
            categories = raw3['data'];

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function initHTML() {
        await setPopupAdd('popup-add');

    }

    async function Card1() {
        console.log("Card 1");
        const table_type = 1;     //Watch table id in 
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type + "&aDay=" + diff.day);
            const raw = await res.json();
            const table = Object.values(raw.data);

            const mealsCount = table[0].value;
            const volumeMeal = table[0].children[0]['value'];
            const totalMealperDay = (toNumber(mealsCount) * toNumber(volumeMeal)) || "-";

            SetValueInHTMLById('meals-count', mealsCount);
            SetValueInHTMLById('volume-meal', volumeMeal);
            SetValueInHTMLById('total-meal-per-day', totalMealperDay);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function Card2() {
        console.log("Card 2");
        const table_type_humidity = 5;     //Watch table id in database
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type_humidity + "&aDay=" + diff.day);
            const raw = await res.json();
            const humidityTable = Object.values(raw.data);

            const humidity = humidityTable[0].value;

            SetValueInHTMLById('humidity', humidity + "%");

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }


        // =============== Light ==============
        const table_type_light = 4;     //Watch table id in database
        try {
            const res = await fetch('../../api-website/fetch_tableByTypeId.php?typeId=' + table_type_light + "&aDay=" + diff.day);
            const raw = await res.json();
            const LuminanceTable = Object.values(raw.data);
            console.log(LuminanceTable);

            const totalhours = LuminanceTable[0].value;
            const lighttime = LuminanceTable[0].children[0].value;
            const luminance = LuminanceTable[0].children[1].value;

            SetValueInHTMLById('total-hours', totalhours);
            SetValueInHTMLById('light-time', lighttime);
            SetValueInHTMLById('light-recommentation', luminance);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }

    }

    async function Card3() {
        console.log("Card 3");
        try {
            const res = await fetch('../../api-website/fetch_expenseBycategory.php?bid=1');
            const raw = await res.json();
            const expense = raw['data'];


            const electricityEl = document.getElementById('electricity-usage');
            const waterEl = document.getElementById('water-usage');

            if (electricityEl) {
                electricityEl.style.fontSize = (fontSize * 2) + "px";
                electricity = Number(expense[0]?.electricity) || 0;
                electricityEl.textContent = electricity;
            }
            if (waterEl) {
                waterEl.style.fontSize = (fontSize * 2) + "px";
                water = Number(expense[0]?.water) || 0;
                waterEl.textContent = water;
            }

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }

    }

    async function Card4() {
        console.log("Card 4");
        try {
            const res = await fetch('../../api-website/fetch_expenseBycategory.php?bid=1');
            const raw = await res.json();
            const expense = raw['data'];

            const electricity = Number(expense[0]?.electricity) || 0;
            const water = Number(expense[0]?.water) || 0;
            const hardware = Number(expense[0]?.hardware) || 0;
            const infrastructure = Number(expense[0]?.infrastructure) || 0;
            const miscellaneous = Number(expense[0]?.miscellaneous) || 0;
            const total = hardware + infrastructure + miscellaneous + electricity + water;

            SetValueInHTMLById('electricity-usage', electricity);
            SetValueInHTMLById('water-usage', water);
            SetValueInHTMLById('expense-hardware', hardware);
            SetValueInHTMLById('expense-infrastructure', infrastructure);
            SetValueInHTMLById('expense-miscellaneous', miscellaneous);
            SetValueInHTMLById('expense-total', total);

        } catch (err) {
            console.error('❌ loadSensorData error:', err);
        }
    }

    async function FilterDataForSearch(datas) {
        await SetDataTable(datas);
    }

    function SetDataTable(filtered, page = 1) {

        const tableView = document.getElementById('table-view');
        if (!tableView) return;

        const tbody = tableView.querySelector('tbody');
        tbody.innerHTML = '';

        let filteredArray = Array.isArray(filtered) ? filtered : Object.values(filtered);

        globalData = filteredArray;
        currentPage = page;

        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = filteredArray.slice(start, end);

        paginatedData.forEach((f) => {

            let date = new Date(f['start_expense_date']);
            let month = date.getMonth() + 1;
            let day = date.getDate();
            const id = f['expense_id'] || 0;

            let categoryName = categories.find(c => c['id'].toString() == f['category_id'].toString())?.name || "--";
            let branchName = branchs.find(b => b['branch_id'].toString() == branch_id.toString())?.branch_name || "--";

            let row = document.createElement('tr');
            row.innerHTML = `
            <td class="px-6 py-4 text-[0.75vw]">${branchName}</td>
            <td class="px-6 py-4 text-[0.75vw] font-bold text-emerald-600">${f['amount']}</td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-[0.75vw] font-bold uppercase rounded-md bg-blue-100 text-blue-600">${categoryName}</span>
            </td>
            <td class="px-6 py-4 text-[0.75vw] truncate max-w-xs">${f['description'] ?? ""}</td>
            <td class="px-6 py-4 text-[0.75vw]">${month}/${day}</td>
            <td class="px-6 py-4 text-center">
                <button onclick="setIdForDelete('popup-delete',${id})" 
                    class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg">
                    <span class="material-icons-round text-[1vw]">delete</span>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });

        renderPagination(filteredArray.length);

        // ✅ update showing text
        const prefix = document.getElementById("prefix-pagination");
        const suffix = document.getElementById("suffix-pagination");

        const totalItems = filteredArray.length;

        let startItem = (currentPage - 1) * rowsPerPage + 1;
        let endItem = Math.min(currentPage * rowsPerPage, totalItems);

        if (totalItems === 0) {
            startItem = 0;
            endItem = 0;
        }

        if (prefix) prefix.textContent = `${startItem}-${endItem}`;
        if (suffix) suffix.textContent = totalItems;
    }

    function renderPagination(totalItems) {

        const totalPages = Math.ceil(totalItems / rowsPerPage);
        const container = document.querySelector(".flex.items-center.gap-1");
        container.innerHTML = '';

        // Previous
        const prevBtn = document.createElement('button');
        prevBtn.textContent = "Previous";
        prevBtn.disabled = currentPage === 1;
        prevBtn.className = "px-[0.5vw] py-1.5 text-[0.75vw] disabled:opacity-50";
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                SetDataTable(globalData, currentPage - 1);
            }
        };
        container.appendChild(prevBtn);

        // Page Numbers
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `
            w-[1.25vw] h-[1.25vw] flex items-center justify-center rounded-lg text-[0.75vw]
            ${i === currentPage ? 'bg-primary text-white' : 'text-slate-600'}
        `;
            btn.onclick = () => SetDataTable(globalData, i);
            container.appendChild(btn);
        }

        // Next
        const nextBtn = document.createElement('button');
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.className = "px-[0.5vw] py-1.5 text-[0.75vw] disabled:opacity-50";
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                SetDataTable(globalData, currentPage + 1);
            }
        };
        container.appendChild(nextBtn);
    }




    function setPopupAdd(id) {
        const addPopup = document.getElementById(id);
        if (!addPopup) {
            console.warn("ไม่พบ ID : " + id);
            return;
        }
        const branchEl = addPopup.querySelector("#select-branch");
        const categoryEl = addPopup.querySelector("#select-category");

        branchEl.innerHTML = '';
        branchs.forEach(b => {
            let option = document.createElement('option');
            option.value = b['branch_id'] ?? 0;
            option.textContent = b['branch_name'] ?? "unknown";
            branchEl.appendChild(option);
        });

        categoryEl.innerHTML = '';
        categories.forEach(c => {
            let option = document.createElement('option');
            option.value = c['id'] ?? 0;
            option.textContent = c['name'] ?? "unknown";
            categoryEl.appendChild(option);
        });
    }

    function setIdForDelete(id, rowId) {
        showPopup(id);
        row_id_will_delete = rowId;
    }


    async function saveData(id) {
        const addPopup = document.getElementById(id);
        if (!addPopup) {
            console.warn("ไม่พบ ID : " + id);
            return;
        }
        const branch = addPopup.querySelector("#select-branch");
        const amount = addPopup.querySelector("#amount");
        const category = addPopup.querySelector("#select-category");
        const start = addPopup.querySelector("#start-date");
        const description = addPopup.querySelector("#description");

        try {
            const response = await fetch("../../api-website/create-expense.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'branch_id': branch.value || 1,
                    'amount': amount.value || 0,
                    'category_id': category.value || '0',
                    'description': description.value || 1,
                    'start': start.value || null,
                    'end': start.value || null,
                }),
            });
            const result = await response.json();
            console.log(result);

            await process();

            showPopup('popup-result-add');
            setTimeout(() => {
                hidePopup('popup-result-add');
            }, 2000);

        } catch (err) {
            console.error("Error:", err);
        }

        hidePopup(id);
    }

    async function deleteData(button, id) {
        button.disabled = true;
        const deletePopup = document.getElementById(id);
        if (!deletePopup) {
            console.warn("ไม่พบ ID : " + id);
            return;
        }

        try {
            const response = await fetch("../../api-website/delete-expense.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'id': row_id_will_delete
                }),
            });
            const result = await response.json();
            console.log(result);

            await process();

            showPopup('popup-result-delete');
            setTimeout(() => {
                hidePopup('popup-result-delete');
            }, 2000);

        } catch (err) {
            console.error("Error:", err);
        }

        button.disabled = false;
        hidePopup(id);
    }

</script>