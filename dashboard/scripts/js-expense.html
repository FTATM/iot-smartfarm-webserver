<!-- JavaScript -->
<script>
    let datas = [];
    let diffDatas = [];
    let branchs = [];
    let categories = [];
    let isLoading = true;
    let row_id_will_delete = 0;
    let sensor_select = 0;

    //Table
    let currentPage = 1;
    const rowsPerPage = Math.ceil(screenHeight * 0.008);
    let globalData = [];

    const branch_id = 1;
    const category_type = 'expense';
    const market_name = "";           //name market example => solar, shrimp, indoor, outdoor
    const type = "price";             //multi type example => demand,price

    // Adjust font sizes based on screen width
    document.addEventListener('DOMContentLoaded', async () => {

        await process();
        isLoading = false;
        // setInterval(async () => {
        // }, 10000);

    });

    async function process() {
        await initLoadData();
        await initHTML();
        await FilterDataForSearch(datas);

        Card1();
        Card2();
        Card3(diffDatas, datas);
        Card4(datas);
    }

    async function initLoadData() {
        try {
            const resbr = await fetch('../../api-website/fetch_branch.php');
            const raw2 = await resbr.json();
            branchs = raw2['data'];
            const rescat = await fetch('../../api-website/fetch_categories.php?type=' + category_type);
            const raw3 = await rescat.json();
            categories = raw3['data'];

            const resdata = await fetch('../../api-website/fetch_incomes.php');
            const raw1 = await resdata.json();
            diffDatas = raw1['data'];
            const resdata2 = await fetch('../../api-website/fetch_expenses.php');
            const raw4 = await resdata2.json();
            datas = raw4['data'];

        } catch (err) {
            console.error('âŒ loadSensorData error:', err);
        }
    }

    async function initHTML() {
        await setPopupAdd('popup-add');

    }

    async function Card1() {
        console.log("Card 1");
        try {
            if (!Array.isArray(diffDatas) || diffDatas.length === 0) {

            }

            // ðŸ”¹ group à¸¢à¸­à¸”à¸•à¸²à¸¡à¹€à¸”à¸·à¸­à¸™ (format: YYYY-MM)
            const monthlyTotals = diffDatas.reduce((acc, item) => {
                if (!item.start_income_date || !item.amount) return acc;

                const date = new Date(item.start_income_date);
                if (isNaN(date)) return acc;

                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                acc[key] = (acc[key] || 0) + parseFloat(item.amount);
                return acc;
            }, {});

            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const previousKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;

            const currentTotal = monthlyTotals[currentKey] || 0;
            const previousTotal = monthlyTotals[previousKey] || 0;

            let percent = 0;

            if (previousTotal > 0) {
                percent = ((currentTotal - previousTotal) / previousTotal) * 100;
            }

            SetValueInHTMLById('card-1-total', currentTotal.toLocaleString('th-TH'));
            SetValueInHTMLById('card-1-percent', percent.toFixed(2) + '%');

        } catch (err) {
            console.error('âŒ loadSensorData error:', err);
        }
    }

    async function Card2() {
        console.log("Card 2");
        try {
            if (!Array.isArray(datas) || datas.length === 0) {

            }

            // ðŸ”¹ group à¸¢à¸­à¸”à¸•à¸²à¸¡à¹€à¸”à¸·à¸­à¸™ (format: YYYY-MM)
            const monthlyTotals = datas.reduce((acc, item) => {
                if (!item.start_expense_date || !item.amount) return acc;

                const date = new Date(item.start_expense_date);
                if (isNaN(date)) return acc;

                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                acc[key] = (acc[key] || 0) + parseFloat(item.amount);
                return acc;
            }, {});

            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const previousKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;

            const currentTotal = monthlyTotals[currentKey] || 0;
            const previousTotal = monthlyTotals[previousKey] || 0;

            let percent = 0;

            if (previousTotal > 0) {
                percent = ((currentTotal) / previousTotal) * 100;
            }

            const barProcess = document.getElementById('card-2-bar-process');
            barProcess.style.width = percent.toFixed(1) + "%";

            SetValueInHTMLById('card-2-total', currentTotal.toLocaleString('th-TH'));
            SetValueInHTMLById('card-2-percent', percent.toFixed(2) + '%');
            SetValueInHTMLById('card-2-lastMonth', 'à¸¿' + previousTotal.toLocaleString('th-TH'));

        } catch (err) {
            console.error('âŒ loadSensorData error:', err);
        }
    }

    function Card3(income_data, expense_data) {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        // à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸”à¸·à¸­à¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
        const filterIncomeMonth = (data) => {
            return data.filter(item => {
                const d = new Date(item.start_income_date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
        };

        // à¸à¸£à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸”à¸·à¸­à¸™à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
        const filterExpenseMonth = (data) => {
            return data.filter(item => {
                const d = new Date(item.start_expense_date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
        };

        const incomeMonth = filterIncomeMonth(income_data);
        const expenseMonth = filterExpenseMonth(expense_data);

        const totalIncome = incomeMonth.reduce((sum, i) => sum + Number(i.amount), 0);
        const totalExpense = expenseMonth.reduce((sum, i) => sum + Number(i.amount), 0);

        const netProfit = totalIncome - totalExpense;

        // à¹à¸ªà¸”à¸‡à¸¢à¸­à¸”à¸£à¸§à¸¡
        document.getElementById("card3-total").textContent = formatNumber(netProfit);

        // ===== Weekly Net Profit =====
        const weeks = [0, 0, 0, 0];

        incomeMonth.forEach(item => {
            const day = new Date(item.start_income_date).getDate();
            const weekIndex = Math.floor((day - 1) / 7);
            weeks[weekIndex] += Number(item.amount);
        });

        expenseMonth.forEach(item => {
            const day = new Date(item.start_expense_date).getDate();
            const weekIndex = Math.floor((day - 1) / 7);
            weeks[weekIndex] -= Number(item.amount);
        });
        

        const maxValue = Math.max(...weeks.map(w => Math.abs(w)), 1);

        const barsContainer = document.getElementById("card3-bars");
        barsContainer.innerHTML = "";

        weeks.forEach(value => {

            const percent = (Math.abs(value) / maxValue) * 100;

            const bar = document.createElement("div");
            bar.className = "flex-1 rounded-t-sm transition-all";
            bar.style.height = percent + "%";
            bar.classList.add(
                value >= 0
                    ? "bg-emerald-400"
                    : "bg-red-400"
            );

            barsContainer.appendChild(bar);
        });
    }

    function Card4(income_data) {

        const categoryMap = {};

        income_data.forEach(item => {
            if (!categoryMap[item.category_id]) {
                categoryMap[item.category_id] = 0;
            }
            categoryMap[item.category_id] += Number(item.amount);
        });

        const sorted = Object.entries(categoryMap)
            .sort((a, b) => b[1] - a[1]);

        const totalIncome = sorted.reduce((sum, c) => sum + c[1], 0);

        const top3 = sorted.slice(0, 3);

        const listEl = document.getElementById("card4-list");
        const progressEl = document.getElementById("card4-progress");

        listEl.innerHTML = "";
        progressEl.innerHTML = "";

        top3.forEach((item, index) => {

            const categoryId = item[0];
            const amount = item[1];
            const percent = ((amount / totalIncome) * 100).toFixed(1);

            let categoryName = categories.find(c => c['id'].toString() == categoryId.toString())?.name || "--";

            listEl.innerHTML += `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center font-bold text-[10px]">
                        #${index + 1}
                    </div>
                    <div>
                        <p class="text-xs font-semibold">${categoryName}</p>
                        <p class="text-[10px] text-slate-400">ID: ${categoryId}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs font-bold">à¸¿${formatNumber(amount)}</p>
                    <p class="text-[10px] text-slate-400">${percent}%</p>
                </div>
            </div>
        `;

            const bar = document.createElement("div");
            bar.className = "h-full";
            bar.style.width = percent + "%";
            bar.classList.add(
                index === 0 ? "bg-blue-500" :
                    index === 1 ? "bg-purple-500" :
                        "bg-orange-400"
            );

            progressEl.appendChild(bar);
        });
    }

    async function FilterDataForSearch(datas) {
        await SetDataTable(datas);
    }

    function SetDataTable(filtered, page = 1) {

        const tableView = document.getElementById('table-view');
        if (!tableView) return;

        const tbody = tableView.querySelector('tbody');
        tbody.innerHTML = '';

        let filteredArray = Array.isArray(filtered) ? filtered : Object.values(filtered);

        globalData = filteredArray;
        currentPage = page;

        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = filteredArray.slice(start, end);

        paginatedData.forEach((f) => {

            let date = new Date(f['start_expense_date']);
            let month = date.getMonth() + 1;
            let day = date.getDate();
            const id = f['expense_id'] || 0;

            let categoryName = categories.find(c => c['id'].toString() == f['category_id'].toString())?.name || "--";
            let branchName = branchs.find(b => b['branch_id'].toString() == branch_id.toString())?.branch_name || "--";

            let row = document.createElement('tr');
            row.innerHTML = `
            <td class="px-6 py-4 text-[0.75vw]">${branchName}</td>
            <td class="px-6 py-4 text-[0.75vw] font-bold text-emerald-600">${f['amount']}</td>
            <td class="px-6 py-4">
                <span class="px-2 py-1 text-[0.75vw] font-bold uppercase rounded-md bg-blue-100 text-blue-600">${categoryName}</span>
            </td>
            <td class="px-6 py-4 text-[0.75vw] truncate max-w-xs">${f['description'] ?? ""}</td>
            <td class="px-6 py-4 text-[0.75vw]">${month}/${day}</td>
            <td class="px-6 py-4 text-center">
                <button onclick="setIdForDelete('popup-delete',${id})" 
                    class="p-2 text-rose-500 hover:bg-rose-50 rounded-lg">
                    <span class="material-icons-round text-[1vw]">delete</span>
                </button>
            </td>
        `;
            tbody.appendChild(row);
        });

        renderPagination(filteredArray.length);

        // âœ… update showing text
        const prefix = document.getElementById("prefix-pagination");
        const suffix = document.getElementById("suffix-pagination");

        const totalItems = filteredArray.length;

        let startItem = (currentPage - 1) * rowsPerPage + 1;
        let endItem = Math.min(currentPage * rowsPerPage, totalItems);

        if (totalItems === 0) {
            startItem = 0;
            endItem = 0;
        }

        if (prefix) prefix.textContent = `${startItem}-${endItem}`;
        if (suffix) suffix.textContent = totalItems;
    }

    function renderPagination(totalItems) {

        const totalPages = Math.ceil(totalItems / rowsPerPage);
        const container = document.querySelector(".flex.items-center.gap-1");
        container.innerHTML = '';

        // Previous
        const prevBtn = document.createElement('button');
        prevBtn.textContent = "Previous";
        prevBtn.disabled = currentPage === 1;
        prevBtn.className = "px-[0.5vw] py-1.5 text-[0.75vw] disabled:opacity-50";
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                SetDataTable(globalData, currentPage - 1);
            }
        };
        container.appendChild(prevBtn);

        // Page Numbers
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = `
            w-[1.25vw] h-[1.25vw] flex items-center justify-center rounded-lg text-[0.75vw]
            ${i === currentPage ? 'bg-primary text-white' : 'text-slate-600'}
        `;
            btn.onclick = () => SetDataTable(globalData, i);
            container.appendChild(btn);
        }

        // Next
        const nextBtn = document.createElement('button');
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.className = "px-[0.5vw] py-1.5 text-[0.75vw] disabled:opacity-50";
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                SetDataTable(globalData, currentPage + 1);
            }
        };
        container.appendChild(nextBtn);
    }




    function setPopupAdd(id) {
        const addPopup = document.getElementById(id);
        if (!addPopup) {
            console.warn("à¹„à¸¡à¹ˆà¸žà¸š ID : " + id);
            return;
        }
        const branchEl = addPopup.querySelector("#select-branch");
        const categoryEl = addPopup.querySelector("#select-category");

        branchEl.innerHTML = '';
        branchs.forEach(b => {
            let option = document.createElement('option');
            option.value = b['branch_id'] ?? 0;
            option.textContent = b['branch_name'] ?? "unknown";
            branchEl.appendChild(option);
        });

        categoryEl.innerHTML = '';
        categories.forEach(c => {
            let option = document.createElement('option');
            option.value = c['id'] ?? 0;
            option.textContent = c['name'] ?? "unknown";
            categoryEl.appendChild(option);
        });
    }

    function setIdForDelete(id, rowId) {
        showPopup(id);
        row_id_will_delete = rowId;
    }


    async function saveData(id) {
        const addPopup = document.getElementById(id);
        if (!addPopup) {
            console.warn("à¹„à¸¡à¹ˆà¸žà¸š ID : " + id);
            return;
        }
        const branch = addPopup.querySelector("#select-branch");
        const amount = addPopup.querySelector("#amount");
        const category = addPopup.querySelector("#select-category");
        const start = addPopup.querySelector("#start-date");
        const description = addPopup.querySelector("#description");

        try {
            const response = await fetch("../../api-website/create-expense.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'branch_id': branch.value || 1,
                    'amount': amount.value || 0,
                    'category_id': category.value || '0',
                    'description': description.value || 1,
                    'start': start.value || null,
                    'end': start.value || null,
                }),
            });
            const result = await response.json();
            console.log(result);

            await process();

            showPopup('popup-result-add');
            setTimeout(() => {
                hidePopup('popup-result-add');
            }, 2000);

        } catch (err) {
            console.error("Error:", err);
        }

        hidePopup(id);
    }

    async function deleteData(button, id) {
        button.disabled = true;
        const deletePopup = document.getElementById(id);
        if (!deletePopup) {
            console.warn("à¹„à¸¡à¹ˆà¸žà¸š ID : " + id);
            return;
        }

        try {
            const response = await fetch("../../api-website/delete-expense.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    'id': row_id_will_delete
                }),
            });
            const result = await response.json();
            console.log(result);

            await process();

            showPopup('popup-result-delete');
            setTimeout(() => {
                hidePopup('popup-result-delete');
            }, 2000);

        } catch (err) {
            console.error("Error:", err);
        }

        button.disabled = false;
        hidePopup(id);
    }

</script>